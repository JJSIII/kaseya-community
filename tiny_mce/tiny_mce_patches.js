// Correction for bug #28521: editor.parser.parse() cannot be called within a node filter (affects media, hashtags, mentions):
(function (e) { var t = e.html.Node; e.html.DomParser = function (n, r) { function u(n, s, o) { var u, a, f, l, c, h, p, d, v, m, g, y, b, w; y = e.makeMap("tr,td,th,tbody,thead,tfoot,table"); g = r.getNonEmptyElements(); for (u = 0; u < n.length; u++) { a = n[u]; if (!a.parent) continue; l = [a]; for (f = a.parent; f && !r.isValidChild(f.name, a.name) && !y[f.name]; f = f.parent) l.push(f); if (f && l.length > 1) { l.reverse(); c = h = i.filterNode(l[0].clone()); for (v = 0; v < l.length - 1; v++) { if (r.isValidChild(h.name, l[v].name)) { p = i.filterNode(l[v].clone()); h.append(p) } else p = h; for (d = l[v].firstChild; d && d != l[v + 1]; ) { w = d.next; p.append(d); d = w } h = p } if (!c.isEmpty(g)) { f.insert(c, l[0], true); f.insert(a, c) } else { f.insert(a, l[0], true) } f = l[0]; if (f.isEmpty(g) || f.firstChild === f.lastChild && f.firstChild.name === "br") { f.empty().remove() } } else if (a.parent) { if (a.name === "li") { b = a.prev; if (b && (b.name === "ul" || b.name === "ul")) { b.append(a); continue } b = a.next; if (b && (b.name === "ul" || b.name === "ul")) { b.insert(a, b.firstChild, true); continue } a.wrap(i.filterNode(new t("ul", 1))); continue } if (r.isValidChild(a.parent.name, "div") && r.isValidChild("div", a.name)) { a.wrap(i.filterNode(new t("div", 1))) } else { if (a.name === "style" || a.name === "script") a.empty().remove(); else a.unwrap() } } } } var i = this, s = {}, o = []; n = n || {}; n.validate = "validate" in n ? n.validate : true; n.root_name = n.root_name || "body"; i.schema = r = r || new e.html.Schema; i.filterNode = function (e) { var t, n, r; if (n in s) { r = matchedNodes[n]; if (r) r.push(e); else matchedNodes[n] = [e] } t = o.length; while (t--) { n = o[t].name; if (n in e.attributes.map) { r = matchedAttributes[n]; if (r) r.push(e); else matchedAttributes[n] = [e] } } return e }; i.addNodeFilter = function (t, n) { e.each(e.explode(t), function (e) { var t = s[e]; if (!t) s[e] = t = []; t.push(n) }) }; i.addAttributeFilter = function (t, n) { e.each(e.explode(t), function (e) { var t; for (t = 0; t < o.length; t++) { if (o[t].name === e) { o[t].callbacks.push(n); return } } o.push({ name: e, callbacks: [n] }) }) }; i.parse = function (i, a) { function D() { var e = l.firstChild, t, n; while (e) { t = e.next; if (e.type == 3 || e.type == 1 && e.name !== "p" && !w[e.name] && !e.attr("data-mce-type")) { if (!n) { n = P(O, 1); l.insert(n, e); n.append(e) } else n.append(e) } else { n = null } e = t } } function P(e, n) { var r = new t(e, n), i; if (e in s) { i = M[e]; if (i) i.push(r); else M[e] = [r] } return r } function H(e) { var t, n, r; for (t = e.prev; t && t.type === 3; ) { n = t.value.replace(T, ""); if (n.length > 0) { t.value = n; t = t.prev } else { r = t.prev; t.remove(); t = r } } } function B(e) { var t, n = {}; for (t in e) { if (t !== "li" && t != "p") { n[t] = e[t] } } return n } var f, l, c, h, p, d, v, m, g, y, b, w, E, S = [], x, T, N, C, k, L, A, O, M, _; a = a || {}; M = {}; _ = {}; w = e.extend(e.makeMap("script,style,head,html,body,title,meta,param"), r.getBlockElements()); A = r.getNonEmptyElements(); L = r.children; b = n.validate; O = "forced_root_block" in a ? a.forced_root_block : n.forced_root_block; k = r.getWhiteSpaceElements(); E = /^[ \t\r\n]+/; T = /[ \t\r\n]+$/; N = /[ \t\r\n]+/g; C = /^[ \t\r\n]+$/; f = new e.html.SaxParser({ validate: b, self_closing_elements: B(r.getSelfClosingElements()), cdata: function (e) { c.append(P("#cdata", 4)).value = e }, text: function (e, t) { var n; if (!x) { e = e.replace(N, " "); if (c.lastChild && w[c.lastChild.name]) e = e.replace(E, "") } if (e.length !== 0) { n = P("#text", 3); n.raw = !!t; c.append(n).value = e } }, comment: function (e) { c.append(P("#comment", 8)).value = e }, pi: function (e, t) { c.append(P(e, 7)).value = t; H(c) }, doctype: function (e) { var t; t = c.append(P("#doctype", 10)); t.value = e; H(c) }, start: function (e, t, n) { var i, s, u, a, f, l, h, p; u = b ? r.getElementRule(e) : {}; if (u) { i = P(u.outputName || e, 1); i.attributes = t; i.shortEnded = n; c.append(i); p = L[c.name]; if (p && L[i.name] && !p[i.name]) S.push(i); s = o.length; while (s--) { f = o[s].name; if (f in t.map) { g = _[f]; if (g) g.push(i); else _[f] = [i] } } if (w[e]) H(i); if (!n) c = i; if (!x && k[e]) { x = true } } }, end: function (e) { var n, i, s, o, u; i = b ? r.getElementRule(e) : {}; if (i) { if (w[e]) { if (!x) { n = c.firstChild; if (n && n.type === 3) { s = n.value.replace(E, ""); if (s.length > 0) { n.value = s; n = n.next } else { o = n.next; n.remove(); n = o } while (n && n.type === 3) { s = n.value; o = n.next; if (s.length === 0 || C.test(s)) { n.remove(); n = o } n = o } } n = c.lastChild; if (n && n.type === 3) { s = n.value.replace(T, ""); if (s.length > 0) { n.value = s; n = n.prev } else { o = n.prev; n.remove(); n = o } while (n && n.type === 3) { s = n.value; o = n.prev; if (s.length === 0 || C.test(s)) { n.remove(); n = o } n = o } } } n = c.prev; if (n && n.type === 3) { s = n.value.replace(E, ""); if (s.length > 0) n.value = s; else n.remove() } } if (x && k[e]) { x = false } if (i.removeEmpty || i.paddEmpty) { if (c.isEmpty(A)) { if (i.paddEmpty) c.empty().append(new t("#text", "3")).value = " "; else { if (!c.attributes.map.name && !c.attributes.map.id) { u = c.parent; c.empty().remove(); c = u; return } } } } c = c.parent } } }, r); l = c = new t(a.context || n.root_name, 11); f.parse(i); if (b && S.length) { if (!a.context) u(S, M, _); else a.invalid = true } if (O && l.name == "body") D(); if (!a.invalid) { for (y in M) { g = s[y]; h = M[y]; v = h.length; while (v--) { if (!h[v].parent) h.splice(v, 1) } for (p = 0, d = g.length; p < d; p++) g[p](h, y, a) } for (p = 0, d = o.length; p < d; p++) { g = o[p]; if (g.name in _) { h = _[g.name]; v = h.length; while (v--) { if (!h[v].parent) h.splice(v, 1) } for (v = 0, m = g.callbacks.length; v < m; v++) g.callbacks[v](h, g.name, a) } } } return l }; if (n.remove_trailing_brs) { i.addNodeFilter("br", function (t, n) { var i, s = t.length, o, u = e.extend({}, r.getBlockElements()), a = r.getNonEmptyElements(), f, l, c, h; u.body = 1; for (i = 0; i < s; i++) { o = t[i]; f = o.parent; if (u[o.parent.name] && o === f.lastChild) { c = o.prev; while (c) { h = c.name; if (h !== "span" || c.attr("data-mce-type") !== "bookmark") { if (h !== "br") break; if (h === "br") { o = null; break } } c = c.prev } if (o) { o.remove(); if (f.isEmpty(a)) { elementRule = r.getElementRule(f.name); if (elementRule) { if (elementRule.removeEmpty) f.remove(); else if (elementRule.paddEmpty) f.empty().append(new e.html.Node("#text", 3)).value = " " } } } } else { l = o; while (f.firstChild === l && f.lastChild === l) { l = f; if (u[f.name]) { break } f = f.parent } if (l === f) { textNode = new e.html.Node("#text", 3); textNode.value = " "; o.replace(textNode) } } } }) } if (!n.allow_html_in_named_anchor) { i.addAttributeFilter("id,name", function (e, t) { var n = e.length, r, i, s, o; while (n--) { o = e[n]; if (o.name === "a" && o.firstChild && !o.attr("href")) { s = o.parent; r = o.lastChild; do { i = r.prev; s.insert(r, o); r = i } while (r) } } }) } } })(tinymce)